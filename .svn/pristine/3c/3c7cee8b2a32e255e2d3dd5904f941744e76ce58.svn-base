using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using Yaohuasoft.Framework.DAL;
using Yaohuasoft.Framework.BLL;
using Yaohuasoft.Framework.Library;
namespace   Yaohuasoft.Framework.WebUI.SysAdmin
{
    public partial class DrugfactoryInfoDetail : System.Web.UI.Page
    {
        public DrugfactoryInfoDALEntity entity = new DrugfactoryInfoDALEntity();
        protected void Page_Load(object sender, EventArgs e)
        {
            //绑定数据
            if (!IsPostBack)
            {
							CheckSession();
                Bind();
            }
        }
        protected void CheckSession()
        {
                ////验证登录权限
                SessionUtils check = new SessionUtils();
                bool result = check.CheckPower("SysAdmin");
            if (result == true)
                result=check.CheckPower("SysAdmin", "药厂信息");
                if (result == false)
                {
				Response.Write("<script>   top.window.location.href = '/Logout.aspx?r='+Math.random() ;</script>");
                ////Response.Redirect("/Logout.aspx");
                }
		}
        protected void Bind()
        {
            if (string.IsNullOrEmpty(Request["id"]))
            {
                Response.Redirect("DrugfactoryInfo_List.aspx?rnd="+YaohuaID.GenRandomInt()+"&query="+HttpUtility.UrlEncode(Request["query"])+"&id="+HttpUtility.UrlEncode(Request["id"])+"");
            }
            string id = HttpUtility.UrlDecode(Request["id"]).ToString();
            entity = Yaohuasoft.Framework.BLL.SysAdmin.DrugfactoryInfoBLL.GetEntity(id,Session["CorpId"].ToStr(),Session["DepartmentId"].ToStr(),Session["UserName"].ToStr());
			////必须克隆不然会影响缓存数据
            entity = entity.Clone();
entity.FactoryGrade=SysConfigService.GetValue(Session["CorpId"].ToStr(),"FACTORY_GRADE",entity.FactoryGrade.ToStr());
this.imgFactoryLogo.ImageUrl=entity.FactoryLogo.ToStr();
this.imgBusinessLicencePic.ImageUrl=entity.BusinessLicencePic.ToStr();
this.imgLegalIdentityPic.ImageUrl=entity.LegalIdentityPic.ToStr();
tbSeoDescription.Text=entity.SeoDescription.ToStr();
            hfID.Value = id.ToString();
        }
        protected void btnDelete_Click(object sender, EventArgs e)
        {
            string id = hfID.Value.ToString();
            var ret = Yaohuasoft.Framework.BLL.SysAdmin.DrugfactoryInfoBLL.Delete(id,Session["CorpId"].ToStr(),Session["DepartmentId"].ToStr(),Session["UserName"].ToStr());
            if (ret > 0)
            {
                Response.Redirect("DrugfactoryInfo_List.aspx?rnd="+YaohuaID.GenRandomInt()+"&query="+HttpUtility.UrlEncode(Request["query"])+"&id="+HttpUtility.UrlEncode(Request["id"])+"");
            }
            Bind();
            errormsg.Text = "操作失败！";
        }
        protected void btnShenQing_Click(object sender, EventArgs e)
        {
            string id = hfID.Value.ToString();
            var ret = Yaohuasoft.Framework.BLL.SysAdmin.DrugfactoryInfoBLL.ShenQingById(id,Session["CorpId"].ToStr(),Session["DepartmentId"].ToStr(),Session["UserName"].ToStr());
            Bind();
        }
    }
}
